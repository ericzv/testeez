<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® Organizador de Sprites</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h3 {
            margin-bottom: 15px;
            color: #64ffda;
        }

        /* Filtros */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(100, 255, 218, 0.2);
            border: 1px solid #64ffda;
            border-radius: 5px;
            color: #64ffda;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #64ffda;
            color: #1a1a2e;
        }

        .filter-btn:hover {
            background: rgba(100, 255, 218, 0.3);
        }

        /* Grid de Sprites - para containers 200px */
        .sprites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }

        .sprite-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .sprite-item:hover {
            background: rgba(100, 255, 218, 0.1);
            border-color: #64ffda;
        }

        .sprite-item.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .sprite-preview {
            width: 200px;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin: 0 auto 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sprite-preview:hover {
            border-color: #64ffda;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.3);
        }

        .sprite-preview::after {
            content: 'üé¨';
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: 12px;
            opacity: 0.7;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 3px;
            padding: 2px 4px;
        }

        .sprite-preview:hover::after {
            opacity: 1;
            background: rgba(100, 255, 218, 0.3);
        }

        .animations-paused .sprite-preview::after {
            content: '‚è∏Ô∏è';
            background: rgba(255, 107, 107, 0.3);
        }

        .sprite-image {
            width: 100%;
            height: 100%;
            background-repeat: no-repeat;
            background-position: 0 center;
            background-size: 2200px 200px;
            image-rendering: pixelated;
            animation: sprite-animation 0.8s steps(11) infinite;
            transition: none;
        }

        @keyframes sprite-animation {
            from { 
                background-position: 0 center; 
            }
            to { 
                background-position: -2200px center;
            }
        }

        /* Controle global de anima√ß√µes */
        .animations-paused .sprite-image {
            animation-play-state: paused !important;
        }

        .animations-running .sprite-image {
            animation-play-state: running;
        }

        /* Pausar anima√ß√£o quando n√£o estiver hover para melhor performance */
        .sprite-item:not(:hover) .sprite-image {
            animation-play-state: paused;
        }

        .sprite-item:hover .sprite-image {
            animation-play-state: running;
        }

        /* Override: se anima√ß√µes est√£o globalmente pausadas, manter pausado mesmo no hover */
        .animations-paused .sprite-image {
            animation-play-state: paused !important;
        }

        .sprite-checkbox {
            margin-bottom: 5px;
        }

        .sprite-name {
            font-size: 12px;
            color: #ccc;
        }

        /* Modificadores */
        .modifiers-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 15px;
        }

        .modifier-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .modifier-field {
            display: flex;
            flex-direction: column;
        }

        .modifier-field label {
            margin-bottom: 5px;
            font-size: 14px;
            color: #64ffda;
        }

        .modifier-field input {
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* Temas */
        .themes-section {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .theme-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .theme-select {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .theme-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .theme-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .theme-name {
            font-weight: bold;
            color: #64ffda;
            margin-bottom: 5px;
        }

        .theme-stats {
            font-size: 12px;
            color: #ccc;
        }

        /* Bot√µes */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #64ffda;
            color: #1a1a2e;
        }

        .btn-primary:hover {
            background: #4fd3b3;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: #ff6b6b;
            color: #fff;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Export Section */
        .export-section {
            text-align: center;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Messages */
        .message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }

        /* Scrollbar customization */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 255, 218, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 255, 218, 0.7);
        }

        /* Responsive para sprites maiores */
        @media (max-width: 768px) {
            .themes-section {
                grid-template-columns: 1fr;
            }
            
            .sprites-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* M√≠nimo para caber sprite */
                gap: 15px; /* Gap menor em mobile */
                max-height: 400px; /* Altura menor em mobile */
            }
            
            .sprite-preview {
                width: 140px; /* Ligeiramente menor em mobile */
                height: 140px;
            }
            
            .sprite-image {
                background-size: 1540px 140px; /* Ajustado para mobile: 1408√ó(140/128) = 1540px */
            }
            
            @keyframes sprite-animation {
                from { background-position: 0 center; }
                to { background-position: -1540px center; } /* Ajustado para mobile */
            }
        }

        @media (max-width: 480px) {
            .sprites-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }
            
            .sprite-preview {
                width: 120px; /* Ainda menor em telas muito pequenas */
                height: 120px;
            }
            
            .sprite-image {
                background-size: 1320px 120px; /* 1408√ó(120/128) = 1320px */
            }
            
            @keyframes sprite-animation {
                from { background-position: 0 center; }
                to { background-position: -1320px center; }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üé® Organizador de Sprites e Temas</h1>
            <p>Configure sprites, modificadores e organize temas para inimigos</p>
            
            <!-- Fluxo de Trabalho -->
            <div style="margin-top: 15px; padding: 15px; background: rgba(100, 255, 218, 0.1); border-radius: 8px; border: 1px solid rgba(100, 255, 218, 0.3);">
                <h4 style="color: #64ffda; margin-bottom: 10px;">üìã Fluxo de Trabalho em Etapas</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 12px;">
                    <div>
                        <strong>1Ô∏è‚É£ Primeira Etapa</strong><br>
                        ‚Ä¢ Organize 2-3 temas<br>
                        ‚Ä¢ Configure modificadores<br>
                        ‚Ä¢ üíæ Download JSON
                    </div>
                    <div>
                        <strong>2Ô∏è‚É£ Etapas Seguintes</strong><br>
                        ‚Ä¢ üìÇ Carregar JSON anterior<br>
                        ‚Ä¢ Criar novos temas<br>
                        ‚Ä¢ üíæ Download JSON atualizado
                    </div>
                    <div>
                        <strong>3Ô∏è‚É£ Finaliza√ß√£o</strong><br>
                        ‚Ä¢ üîó Juntar todas as configura√ß√µes<br>
                        ‚Ä¢ üì§ Exportar c√≥digo final<br>
                        ‚Ä¢ Implementar no jogo
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages"></div>

        <!-- Filtros -->
        <div class="section">
            <h3>üîç Filtros</h3>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">Todas</button>
                <button class="filter-btn" data-filter="body">Bodies ({{ sprites.body|length }})</button>
                <button class="filter-btn" data-filter="head">Heads ({{ sprites.head|length }})</button>
                <button class="filter-btn" data-filter="weapon">Weapons ({{ sprites.weapon|length }})</button>
                <button class="filter-btn" data-filter="back">Backs ({{ sprites.back|length }})</button>
                
                <button class="filter-btn" id="toggle-animation" onclick="toggleAnimations()">
                    üé¨ Pausar Anima√ß√µes
                </button>
            </div>
        </div>

        <!-- Grid de Sprites -->
        <div class="section">
            <h3>üñºÔ∏è Sprites Dispon√≠veis</h3>
            <div style="margin-bottom: 10px; font-size: 12px; color: #ccc;">
                üìÇ <a href="/admin/debug/sprites" target="_blank" style="color: #64ffda;">Debug: Verificar Diret√≥rios</a> | 
                Total de sprites: {{ sprites.body|length + sprites.head|length + sprites.weapon|length + sprites.back|length }} |
                üé¨ Anima√ß√µes ativas no hover | 
                üìê Sprites aumentadas 1.6x
            </div>
            
            <!-- Indicador de Progresso -->
            <div id="progress-indicator" style="margin-bottom: 10px; padding: 8px; background: rgba(100, 255, 218, 0.1); border-radius: 5px; border: 1px solid rgba(100, 255, 218, 0.2);">
                <div style="display: flex; gap: 20px; font-size: 12px; color: #64ffda; flex-wrap: wrap;">
                    <span>üé≠ <span id="theme-count">0</span> temas criados</span>
                    <span>‚öôÔ∏è <span id="modifier-count">0</span> sprites configuradas</span>
                    <span>üé® <span id="sprite-count-used">0</span> sprites em uso</span>
                    <span style="color: #ff6b6b; font-weight: bold;">üìê SPRITES EM 200√ó200px</span>
                </div>
            </div>
            <div id="sprite-count" style="margin-bottom: 10px; color: #64ffda; font-size: 14px;">
                Carregando sprites...
            </div>
            <div class="sprites-grid" id="sprites-grid">
                {% for category, sprite_list in sprites.items() %}
                    {% for sprite in sprite_list %}
                        <div class="sprite-item" data-category="{{ category }}" data-sprite="{{ sprite }}">
                            <input type="checkbox" class="sprite-checkbox" value="{{ sprite }}" id="cb-{{ sprite }}">
                            <div class="sprite-preview">
                                <div class="sprite-image" 
                                     style="background-image: url('/static/game.data/enemies/{{ category }}/{{ sprite }}');"
                                     onclick="selectSprite('{{ sprite }}')"
                                     data-sprite="{{ sprite }}"
                                     onerror="this.closest('.sprite-item').style.display='none'"></div>
                            </div>
                            <div class="sprite-name">{{ sprite }}</div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <!-- Modificadores -->
        <div class="section">
            <h3>‚öôÔ∏è Modificadores da Sprite Selecionada</h3>
            <div class="modifiers-section">
                <div id="selected-sprite-info">
                    <p>Selecione uma sprite para editar seus modificadores</p>
                </div>
                <div id="modifier-fields" style="display: none;">
                    <div class="modifier-fields">
                        <div class="modifier-field">
                            <label for="mod-damage">Dano (%)</label>
                            <input type="number" id="mod-damage" value="0" step="1">
                        </div>
                        <div class="modifier-field">
                            <label for="mod-hp">HP (%)</label>
                            <input type="number" id="mod-hp" value="0" step="1">
                        </div>
                        <div class="modifier-field">
                            <label for="mod-posture">Postura (%)</label>
                            <input type="number" id="mod-posture" value="0" step="1">
                        </div>
                        <div class="modifier-field">
                            <label for="mod-armor">Armadura (%)</label>
                            <input type="number" id="mod-armor" value="0" step="1">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveModifiers()">üíæ Salvar Modificadores</button>
                </div>
            </div>
        </div>

        <!-- Temas -->
        <div class="section">
            <h3>üé≠ Gerenciamento de Temas</h3>
            <div class="themes-section">
                <div>
                    <div class="theme-controls">
                        <select id="theme-select" class="theme-select">
                            <option value="">Selecione um tema...</option>
                            {% for theme_name in config.themes.keys() %}
                                <option value="{{ theme_name }}">{{ theme_name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-secondary btn-small" onclick="createTheme()">üìù Novo</button>
                        <button class="btn btn-secondary btn-small" onclick="renameTheme()">‚úèÔ∏è Renomear</button>
                        <button class="btn btn-danger btn-small" onclick="deleteTheme()">üóëÔ∏è Deletar</button>
                    </div>
                    
                    <button class="btn btn-primary" onclick="addSpritesToTheme()">‚ûï Adicionar Sprites Selecionadas ao Tema</button>
                </div>
                
                <div class="theme-list" id="theme-list">
                    <!-- Conte√∫do ser√° carregado via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Export -->
        <div class="section export-section">
            <h3>üì§ Exporta√ß√£o e Backup</h3>
            <div class="export-buttons">
                <button class="btn btn-primary" onclick="exportConfig()">üì§ Exportar Configura√ß√£o</button>
                <button class="btn btn-secondary" onclick="downloadJSON()">üíæ Download JSON</button>
                <button class="btn btn-secondary" onclick="previewThemes()">üëÅÔ∏è Preview Temas</button>
                <button class="btn btn-danger" onclick="showUnusedSprites()">üîç Sprites N√£o Utilizadas</button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                <h4 style="color: #64ffda; margin-bottom: 15px;">üì• Continuar Trabalho Anterior</h4>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importConfig(this)">
                    <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">üìÇ Carregar JSON</button>
                    <button class="btn btn-secondary" onclick="mergeConfigs()">üîó Juntar Configura√ß√µes</button>
                    <button class="btn btn-danger btn-small" onclick="clearAll()">üóëÔ∏è Limpar Tudo</button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                    üí° <strong>Fluxo recomendado:</strong> Organize ‚Üí Download JSON ‚Üí Continue depois ‚Üí Carregue JSON anterior<br>
                    üìÅ <strong>Organiza√ß√£o sugerida:</strong> 
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px;">
                        /backups/backup_temas_20250101_1430.json
                    </code>
                </div>
                
                <!-- Dicas de Organiza√ß√£o -->
                <details style="margin-top: 15px;">
                    <summary style="cursor: pointer; color: #64ffda;">üìö Dicas de Organiza√ß√£o do Trabalho</summary>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; font-size: 12px;">
                        <strong>Sugest√£o de Etapas:</strong><br>
                        ‚Ä¢ <strong>Dia 1:</strong> Temas b√°sicos (Guerreiro, Mago, Assassino) ‚Üí backup_basicos.json<br>
                        ‚Ä¢ <strong>Dia 2:</strong> Temas avan√ßados (Paladino, Necromante) ‚Üí backup_avancados.json<br>
                        ‚Ä¢ <strong>Dia 3:</strong> Temas especiais (Samurai, Ninja) ‚Üí backup_especiais.json<br>
                        ‚Ä¢ <strong>Final:</strong> Juntar todos os backups ‚Üí configuracao_final.json<br><br>
                        
                        <strong>Nomenclatura recomendada:</strong><br>
                        <code>backup_[categoria]_[data]_[hora].json</code><br><br>
                        
                        <strong>Para projetos grandes:</strong><br>
                        ‚Ä¢ Organize por categorias (medieval, futurista, fantasy)<br>
                        ‚Ä¢ Use m√∫ltiplos arquivos e junte no final<br>
                        ‚Ä¢ Mantenha backups regulares durante o trabalho
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let currentSprite = null;
        let selectedSprites = new Set();
        let config = {{ config|tojson }};

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + D para alternar tamanho das sprites
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleSpriteSize();
            }
            
            // Ctrl/Cmd + A para alternar anima√ß√µes
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                toggleAnimations();
            }
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            setupFilters();
            setupCheckboxes();
            loadThemeList();
            loadSpriteModifiers();
            setupImageErrorHandling();
            updateProgressIndicators();
            
            // Inicializar com anima√ß√µes ativas
            document.body.classList.add('animations-running');
        });

        // Setup tratamento de erro para imagens
        function setupImageErrorHandling() {
            const spriteElements = document.querySelectorAll('.sprite-image');
            let loadedCount = 0;
            let totalCount = spriteElements.length;
            let errorCount = 0;
            
            spriteElements.forEach(spriteEl => {
                // Criar uma imagem tempor√°ria para testar se o arquivo existe
                const testImg = new Image();
                const bgImage = spriteEl.style.backgroundImage;
                const imageUrl = bgImage.slice(5, -2); // Remove 'url("' e '")'
                
                testImg.onload = function() {
                    // Imagem carregou com sucesso
                    loadedCount++;
                    updateSpriteCount();
                };
                
                testImg.onerror = function() {
                    // Imagem n√£o carregou - esconder sprite
                    spriteEl.closest('.sprite-item').style.display = 'none';
                    errorCount++;
                    updateSpriteCount();
                    console.warn('Sprite n√£o encontrada:', imageUrl);
                };
                
                testImg.src = imageUrl;
            });
            
            function updateSpriteCount() {
                const countDiv = document.getElementById('sprite-count');
                if (loadedCount + errorCount >= totalCount) {
                    countDiv.innerHTML = `
                        ‚úÖ ${loadedCount} sprites carregadas em 200√ó200px | 
                        ‚ùå ${errorCount} sprites n√£o encontradas | 
                        üìÅ Total: ${totalCount}
                    `;
                    if (errorCount > 0) {
                        countDiv.innerHTML += `<br><small>üí° Sprites n√£o encontradas s√£o ocultadas automaticamente</small>`;
                    }
                    if (loadedCount > 0) {
                        countDiv.innerHTML += `<br><small>üé¨ Hover nas sprites para ver anima√ß√£o | üí° Sprites grandes para melhor visualiza√ß√£o</small>`;
                    }
                }
            }
        }

        // Setup dos filtros
        function setupFilters() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active de todos
                    filterBtns.forEach(b => b.classList.remove('active'));
                    // Adiciona active no clicado
                    this.classList.add('active');
                    
                    const filter = this.dataset.filter;
                    filterSprites(filter);
                });
            });
        }

        // Filtrar sprites
        function filterSprites(category) {
            const sprites = document.querySelectorAll('.sprite-item');
            sprites.forEach(sprite => {
                if (category === 'all' || sprite.dataset.category === category) {
                    sprite.style.display = 'block';
                } else {
                    sprite.style.display = 'none';
                }
            });
        }

        // Setup dos checkboxes
        function setupCheckboxes() {
            const checkboxes = document.querySelectorAll('.sprite-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const sprite = this.value;
                    const spriteItem = this.closest('.sprite-item');
                    
                    if (this.checked) {
                        selectedSprites.add(sprite);
                        spriteItem.classList.add('selected');
                    } else {
                        selectedSprites.delete(sprite);
                        spriteItem.classList.remove('selected');
                    }
                });
            });
        }

        // Selecionar sprite para edi√ß√£o de modificadores
        function selectSprite(sprite) {
            currentSprite = sprite;
            
            // Atualizar interface
            document.getElementById('selected-sprite-info').innerHTML = `
                <p><strong>Sprite Selecionada:</strong> ${sprite}</p>
            `;
            document.getElementById('modifier-fields').style.display = 'block';
            
            // Carregar modificadores existentes
            const modifiers = config.sprite_modifiers[sprite] || {};
            document.getElementById('mod-damage').value = modifiers.damage || 0;
            document.getElementById('mod-hp').value = modifiers.hp || 0;
            document.getElementById('mod-posture').value = modifiers.posture || 0;
            document.getElementById('mod-armor').value = modifiers.armor || 0;
        }

        // Salvar modificadores
        function saveModifiers() {
            if (!currentSprite) {
                showMessage('Selecione uma sprite primeiro', 'error');
                return;
            }

            const modifiers = {
                damage: parseInt(document.getElementById('mod-damage').value) || 0,
                hp: parseInt(document.getElementById('mod-hp').value) || 0,
                posture: parseInt(document.getElementById('mod-posture').value) || 0,
                armor: parseInt(document.getElementById('mod-armor').value) || 0
            };

            fetch('/admin/api/save-modifier', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sprite: currentSprite,
                    modifiers: modifiers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    config.sprite_modifiers[currentSprite] = modifiers;
                    updateProgressIndicators(); // Atualizar contador
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        // Carregar modificadores das sprites
        function loadSpriteModifiers() {
            fetch('/admin/api/get-config')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    config = data.config;
                }
            });
        }

        // Criar novo tema
        function createTheme() {
            const name = prompt('Nome do novo tema:');
            if (!name) return;

            fetch('/admin/api/create-theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: name })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    addThemeToSelect(name);
                    config.themes[name] = {
                        body_options: [],
                        head_options: [],
                        weapon_options: [],
                        back_options: []
                    };
                    loadThemeList();
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        // Renomear tema
        function renameTheme() {
            const select = document.getElementById('theme-select');
            const oldName = select.value;
            if (!oldName) {
                showMessage('Selecione um tema primeiro', 'error');
                return;
            }

            const newName = prompt('Novo nome do tema:', oldName);
            if (!newName || newName === oldName) return;

            fetch('/admin/api/rename-theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    old_name: oldName,
                    new_name: newName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // Atualizar select
                    const option = select.querySelector(`option[value="${oldName}"]`);
                    option.value = newName;
                    option.textContent = newName;
                    select.value = newName;
                    
                    // Atualizar config
                    config.themes[newName] = config.themes[oldName];
                    delete config.themes[oldName];
                    loadThemeList();
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        // Deletar tema
        function deleteTheme() {
            const select = document.getElementById('theme-select');
            const themeName = select.value;
            if (!themeName) {
                showMessage('Selecione um tema primeiro', 'error');
                return;
            }

            if (!confirm(`Tem certeza que deseja deletar o tema "${themeName}"?`)) return;

            fetch('/admin/api/delete-theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: themeName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // Remover do select
                    select.querySelector(`option[value="${themeName}"]`).remove();
                    select.value = '';
                    
                    // Atualizar config
                    delete config.themes[themeName];
                    loadThemeList();
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        // Adicionar sprites ao tema
        function addSpritesToTheme() {
            const themeName = document.getElementById('theme-select').value;
            if (!themeName) {
                showMessage('Selecione um tema primeiro', 'error');
                return;
            }

            if (selectedSprites.size === 0) {
                showMessage('Selecione pelo menos uma sprite', 'error');
                return;
            }

            fetch('/admin/api/add-sprites-to-theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    theme: themeName,
                    sprites: Array.from(selectedSprites)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // Limpar sele√ß√µes
                    selectedSprites.clear();
                    document.querySelectorAll('.sprite-checkbox').forEach(cb => {
                        cb.checked = false;
                        cb.closest('.sprite-item').classList.remove('selected');
                    });
                    // Recarregar lista de temas
                    loadThemeList();
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        // Atualizar indicadores de progresso
        function updateProgressIndicators() {
            const themeCount = Object.keys(config.themes).length;
            const modifierCount = Object.keys(config.sprite_modifiers).length;
            
            // Contar sprites √∫nicas em uso nos temas
            const spritesInUse = new Set();
            for (const theme of Object.values(config.themes)) {
                // Adicionar body_options
                if (theme.body_options) {
                    theme.body_options.forEach(num => spritesInUse.add(`body${num}.png`));
                }
                // Adicionar head_options
                if (theme.head_options) {
                    theme.head_options.forEach(num => spritesInUse.add(`head${num}.png`));
                }
                // Adicionar weapon_options
                if (theme.weapon_options) {
                    theme.weapon_options.forEach(num => spritesInUse.add(`weapon${num}.png`));
                }
                // Adicionar back_options
                if (theme.back_options) {
                    theme.back_options.forEach(num => spritesInUse.add(`back${num}.png`));
                }
            }
            
            document.getElementById('theme-count').textContent = themeCount;
            document.getElementById('modifier-count').textContent = modifierCount;
            document.getElementById('sprite-count-used').textContent = spritesInUse.size;
        }

        // Carregar lista de temas
        function loadThemeList() {
            const themeList = document.getElementById('theme-list');
            themeList.innerHTML = '';

            for (const [themeName, themeData] of Object.entries(config.themes)) {
                const themeItem = document.createElement('div');
                themeItem.className = 'theme-item';
                themeItem.innerHTML = `
                    <div class="theme-name">${themeName}</div>
                    <div class="theme-stats">
                        Bodies: ${themeData.body_options?.length || 0} | 
                        Heads: ${themeData.head_options?.length || 0} | 
                        Weapons: ${themeData.weapon_options?.length || 0} | 
                        Backs: ${themeData.back_options?.length || 0}
                    </div>
                `;
                themeList.appendChild(themeItem);
            }
            
            // Atualizar indicadores de progresso
            updateProgressIndicators();
        }

        // Adicionar tema ao select
        function addThemeToSelect(themeName) {
            const select = document.getElementById('theme-select');
            const option = document.createElement('option');
            option.value = themeName;
            option.textContent = themeName;
            select.appendChild(option);
            select.value = themeName;
        }

        // Exportar configura√ß√£o
        function exportConfig() {
            fetch('/admin/api/export-config')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Configura√ß√£o exportada com sucesso!', 'success');
                    
                    // Mostrar c√≥digo Python em um modal ou nova janela
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <html>
                            <head><title>C√≥digo Python Gerado</title></head>
                            <body style="font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff;">
                                <h2>C√≥digo Python para battle.py:</h2>
                                <pre style="background: #2a2a2a; padding: 20px; border-radius: 5px; overflow-x: auto;">
${data.python_code}
                                </pre>
                                <h2>Arquivo JSON salvo em:</h2>
                                <p>${data.file_path}</p>
                            </body>
                        </html>
                    `);
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        // Preview temas com interface visual
        function previewThemes() {
            fetch('/admin/api/preview-themes')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showThemePreviewModal(data.themes);
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        function showThemePreviewModal(themes) {
            // Criar modal de preview
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                overflow-y: auto;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                max-width: 1400px;
                margin: 0 auto;
                background: linear-gradient(135deg, #1a1a2e, #16213e);
                border-radius: 15px;
                padding: 30px;
                color: white;
                border: 2px solid rgba(100, 255, 218, 0.3);
            `;
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="color: #64ffda; margin: 0;">üëÅÔ∏è Preview dos Temas (${themes.length} temas)</h2>
                    <button onclick="this.closest('.modal').remove()" style="
                        background: #ff6b6b;
                        border: none;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 16px;
                    ">‚úñÔ∏è Fechar</button>
                </div>
            `;
            
            themes.forEach(theme => {
                html += `
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 10px;
                        padding: 20px;
                        margin-bottom: 20px;
                        border: 1px solid rgba(100, 255, 218, 0.2);
                    ">
                        <h3 style="color: #64ffda; margin-bottom: 15px;">
                            üé≠ ${theme.theme_name}
                        </h3>
                        
                        <div style="
                            display: grid;
                            grid-template-columns: 1fr 2fr;
                            gap: 20px;
                            margin-bottom: 20px;
                        ">
                            <div>
                                <h4 style="color: #ccc; margin-bottom: 10px;">üìä Estat√≠sticas:</h4>
                                <ul style="list-style: none; padding: 0; font-size: 14px; color: #aaa;">
                                    <li>üë§ Bodies: ${theme.stats.bodies}</li>
                                    <li>üó£Ô∏è Heads: ${theme.stats.heads}</li>
                                    <li>‚öîÔ∏è Weapons: ${theme.stats.weapons}</li>
                                    <li>üéí Backs: ${theme.stats.backs}</li>
                                    <li style="color: #64ffda; font-weight: bold; margin-top: 10px;">
                                        üé≤ ${theme.stats.total_combinations.toLocaleString()} combina√ß√µes poss√≠veis
                                    </li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 style="color: #ccc; margin-bottom: 15px;">üé® Exemplos de Combina√ß√µes:</h4>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                                    gap: 15px;
                                ">
                `;
                
                theme.combinations.forEach((combo, index) => {
                    html += `
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            border-radius: 8px;
                            padding: 10px;
                            text-align: center;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                        ">
                            <div style="
                                position: relative;
                                width: 100px;
                                height: 100px;
                                margin: 0 auto 10px;
                                background: rgba(255, 255, 255, 0.1);
                                border-radius: 5px;
                            ">
                                ${combo.back ? `
                                    <div class="preview-sprite-layer" style="
                                        position: absolute;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        background-image: url('/static/game.data/enemies/back/${combo.back}');
                                        background-size: 1100px 100px;
                                        background-position: 0 center;
                                        background-repeat: no-repeat;
                                        image-rendering: pixelated;
                                        z-index: 1;
                                        animation: preview-animation 0.8s steps(11) infinite;
                                    "></div>
                                ` : ''}
                                
                                <div class="preview-sprite-layer" style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background-image: url('/static/game.data/enemies/body/${combo.body}');
                                    background-size: 1100px 100px;
                                    background-position: 0 center;
                                    background-repeat: no-repeat;
                                    image-rendering: pixelated;
                                    z-index: 2;
                                    animation: preview-animation 0.8s steps(11) infinite;
                                "></div>
                                
                                <div class="preview-sprite-layer" style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background-image: url('/static/game.data/enemies/head/${combo.head}');
                                    background-size: 1100px 100px;
                                    background-position: 0 center;
                                    background-repeat: no-repeat;
                                    image-rendering: pixelated;
                                    z-index: 3;
                                    animation: preview-animation 0.8s steps(11) infinite;
                                "></div>
                                
                                <div class="preview-sprite-layer" style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background-image: url('/static/game.data/enemies/weapon/${combo.weapon}');
                                    background-size: 1100px 100px;
                                    background-position: 0 center;
                                    background-repeat: no-repeat;
                                    image-rendering: pixelated;
                                    z-index: 4;
                                    animation: preview-animation 0.8s steps(11) infinite;
                                "></div>
                            </div>
                            
                            <div style="font-size: 11px; color: #aaa;">
                                Combo ${index + 1}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                        </div>
                        
                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; color: #64ffda; font-size: 14px;">
                                üé® Ver todas as sprites do tema (${theme.stats.bodies + theme.stats.heads + theme.stats.weapons + theme.stats.backs} sprites)
                            </summary>
                            <div style="margin-top: 15px;" id="theme-sprites-${theme.theme_name.replace(/\s+/g, '-')}">
                                ${generateThemeSpritesGrid(theme.theme_name)}
                            </div>
                        </details>
                    </div>
                `;
            });
            
            // Adicionar CSS para anima√ß√£o de preview
            html += `
                <style>
                    @keyframes preview-animation {
                        from { background-position: 0 center; }
                        to { background-position: -1100px center; }
                    }
                    
                    .theme-sprite-item {
                        position: relative;
                        background: rgba(0, 0, 0, 0.3);
                        border-radius: 5px;
                        padding: 8px;
                        text-align: center;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        transition: all 0.3s;
                    }
                    
                    .theme-sprite-item:hover {
                        border-color: #64ffda;
                        background: rgba(100, 255, 218, 0.1);
                    }
                    
                    .theme-sprite-preview {
                        width: 60px;
                        height: 60px;
                        margin: 0 auto 8px;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 3px;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .theme-sprite-image {
                        width: 100%;
                        height: 100%;
                        background-repeat: no-repeat;
                        background-position: 0 center;
                        background-size: 660px 60px;
                        image-rendering: pixelated;
                        animation: preview-animation 0.8s steps(11) infinite;
                    }
                    
                    .remove-sprite-btn {
                        position: absolute;
                        top: 2px;
                        right: 2px;
                        background: #ff6b6b;
                        border: none;
                        color: white;
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        font-size: 10px;
                        cursor: pointer;
                        display: none;
                        align-items: center;
                        justify-content: center;
                        line-height: 1;
                    }
                    
                    .theme-sprite-item:hover .remove-sprite-btn {
                        display: flex;
                    }
                    
                    .remove-sprite-btn:hover {
                        background: #ff5252;
                    }
                </style>
            `;
            
            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Fechar modal clicando fora
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            showMessage(`Preview carregado: ${themes.length} temas com sprites visuais!`, 'success');
        }

        // Mostrar sprites n√£o utilizadas
        function showUnusedSprites() {
            fetch('/admin/api/unused-sprites')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showUnusedSpritesModal(data);
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        function showUnusedSpritesModal(data) {
            const { unused_sprites, stats, themes } = data;
            
            // Criar modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 1000;
                overflow-y: auto;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                max-width: 1200px;
                margin: 0 auto;
                background: linear-gradient(135deg, #1a1a2e, #16213e);
                border-radius: 15px;
                padding: 30px;
                color: white;
                border: 2px solid rgba(255, 107, 107, 0.3);
            `;
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="color: #ff6b6b; margin: 0;">
                        üîç Sprites N√£o Utilizadas (${stats.total_unused} de ${stats.total_available})
                    </h2>
                    <button onclick="this.closest('.modal').remove()" style="
                        background: #ff6b6b;
                        border: none;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 16px;
                    ">‚úñÔ∏è Fechar</button>
                </div>
                
                <div style="
                    background: rgba(255, 107, 107, 0.1);
                    border-radius: 10px;
                    padding: 20px;
                    margin-bottom: 30px;
                    border: 1px solid rgba(255, 107, 107, 0.3);
                ">
                    <h3 style="color: #ff6b6b; margin-bottom: 15px;">üìä Estat√≠sticas de Uso</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Sprites Utilizadas:</strong> ${stats.total_available - stats.total_unused}<br>
                            <strong>Sprites N√£o Utilizadas:</strong> ${stats.total_unused}<br>
                            <strong>Taxa de Uso:</strong> ${stats.usage_percentage}%
                        </div>
                        <div>
                            <strong>Bodies n√£o utilizados:</strong> ${unused_sprites.body.length}<br>
                            <strong>Heads n√£o utilizados:</strong> ${unused_sprites.head.length}<br>
                            <strong>Weapons n√£o utilizadas:</strong> ${unused_sprites.weapon.length}<br>
                            <strong>Backs n√£o utilizados:</strong> ${unused_sprites.back.length}
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar se√ß√µes por categoria
            const categories = [
                { key: 'body', name: 'üë§ Bodies', icon: 'üë§' },
                { key: 'head', name: 'üó£Ô∏è Heads', icon: 'üó£Ô∏è' },
                { key: 'weapon', name: '‚öîÔ∏è Weapons', icon: '‚öîÔ∏è' },
                { key: 'back', name: 'üéí Backs', icon: 'üéí' }
            ];
            
            categories.forEach(category => {
                const sprites = unused_sprites[category.key];
                
                if (sprites.length > 0) {
                    html += `
                        <div style="
                            background: rgba(255, 255, 255, 0.05);
                            border-radius: 10px;
                            padding: 20px;
                            margin-bottom: 20px;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                        ">
                            <h3 style="color: #64ffda; margin-bottom: 15px;">
                                ${category.icon} ${category.name} N√£o Utilizados (${sprites.length})
                            </h3>
                            
                            <div style="
                                display: grid;
                                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                                gap: 15px;
                            ">
                    `;
                    
                    sprites.forEach(sprite => {
                        html += `
                            <div class="unused-sprite-item" style="
                                background: rgba(0, 0, 0, 0.3);
                                border-radius: 8px;
                                padding: 10px;
                                text-align: center;
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                position: relative;
                                transition: all 0.3s;
                            ">
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    margin: 0 auto 10px;
                                    background: rgba(255, 255, 255, 0.1);
                                    border-radius: 5px;
                                    position: relative;
                                    overflow: hidden;
                                ">
                                    <div style="
                                        width: 100%;
                                        height: 100%;
                                        background-image: url('/static/game.data/enemies/${category.key}/${sprite}');
                                        background-size: 880px 80px;
                                        background-position: 0 center;
                                        background-repeat: no-repeat;
                                        image-rendering: pixelated;
                                        animation: preview-animation-small 0.8s steps(11) infinite;
                                    "></div>
                                </div>
                                
                                <div style="font-size: 11px; color: #ccc; margin-bottom: 10px;">
                                    ${sprite}
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <select class="theme-select-small" data-sprite="${sprite}" style="
                                        padding: 4px;
                                        border: 1px solid rgba(255, 255, 255, 0.3);
                                        border-radius: 3px;
                                        background: rgba(255, 255, 255, 0.1);
                                        color: #fff;
                                        font-size: 10px;
                                    ">
                                        <option value="">Adicionar a tema...</option>
                                        ${themes.map(theme => `<option value="${theme}">${theme}</option>`).join('')}
                                    </select>
                                    
                                    <button onclick="addSpriteToSelectedTheme('${sprite}')" style="
                                        background: #64ffda;
                                        border: none;
                                        color: #1a1a2e;
                                        padding: 4px 8px;
                                        border-radius: 3px;
                                        cursor: pointer;
                                        font-size: 10px;
                                        font-weight: bold;
                                    ">‚ûï Adicionar</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            if (stats.total_unused === 0) {
                html += `
                    <div style="
                        text-align: center;
                        padding: 40px;
                        color: #64ffda;
                        font-size: 18px;
                    ">
                        üéâ Parab√©ns! Todas as sprites est√£o sendo utilizadas nos temas!
                    </div>
                `;
            }
            
            // Adicionar CSS para anima√ß√£o
            html += `
                <style>
                    @keyframes preview-animation-small {
                        from { background-position: 0 center; }
                        to { background-position: -880px center; }
                    }
                    
                    .unused-sprite-item:hover {
                        border-color: #64ffda;
                        background: rgba(100, 255, 218, 0.1);
                        transform: scale(1.05);
                    }
                </style>
            `;
            
            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Fechar modal clicando fora
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            showMessage(`${stats.total_unused} sprites n√£o utilizadas encontradas!`, stats.total_unused > 0 ? 'error' : 'success');
        }

        function addSpriteToSelectedTheme(spriteName) {
            const selectElement = document.querySelector(`[data-sprite="${spriteName}"]`);
            const themeName = selectElement.value;
            
            if (!themeName) {
                showMessage('Selecione um tema primeiro', 'error');
                return;
            }
            
            fetch('/admin/api/add-sprite-to-theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    theme: themeName,
                    sprite: spriteName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    
                    // Atualizar configura√ß√£o local
                    const category = spriteName.startsWith('body') ? 'body_options' :
                                spriteName.startsWith('head') ? 'head_options' :
                                spriteName.startsWith('weapon') ? 'weapon_options' : 'back_options';
                    
                    const spriteNumber = parseInt(spriteName.replace(/[^0-9]/g, ''));
                    if (!config.themes[themeName]) {
                        config.themes[themeName] = { body_options: [], head_options: [], weapon_options: [], back_options: [] };
                    }
                    config.themes[themeName][category].push(spriteNumber);
                    
                    // Remover o item da interface
                    const spriteItem = selectElement.closest('.unused-sprite-item');
                    spriteItem.style.opacity = '0.3';
                    spriteItem.style.pointerEvents = 'none';
                    
                    // Atualizar indicadores se estiver na tela principal
                    if (typeof updateProgressIndicators === 'function') {
                        updateProgressIndicators();
                    }
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Erro ao adicionar sprite: ' + error.message, 'error');
            });
        }

        function generateThemeSpritesGrid(themeName) {
            // Buscar dados do tema atual
            const themeData = config.themes[themeName];
            if (!themeData) return '<p>Tema n√£o encontrado</p>';
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 5px;">';
            
            // Bodies
            if (themeData.body_options && themeData.body_options.length > 0) {
                themeData.body_options.forEach(bodyNum => {
                    html += createSpriteItem(`body${bodyNum}.png`, 'body', themeName);
                });
            }
            
            // Heads
            if (themeData.head_options && themeData.head_options.length > 0) {
                themeData.head_options.forEach(headNum => {
                    html += createSpriteItem(`head${headNum}.png`, 'head', themeName);
                });
            }
            
            // Weapons
            if (themeData.weapon_options && themeData.weapon_options.length > 0) {
                themeData.weapon_options.forEach(weaponNum => {
                    html += createSpriteItem(`weapon${weaponNum}.png`, 'weapon', themeName);
                });
            }
            
            // Backs
            if (themeData.back_options && themeData.back_options.length > 0) {
                themeData.back_options.forEach(backNum => {
                    html += createSpriteItem(`back${backNum}.png`, 'back', themeName);
                });
            }
            
            html += '</div>';
            return html;
        }

        function createSpriteItem(spriteName, category, themeName) {
            return `
                <div class="theme-sprite-item">
                    <button class="remove-sprite-btn" onclick="removeSpriteFromTheme('${themeName}', '${spriteName}')" title="Remover do tema">
                        ‚úñ
                    </button>
                    <div class="theme-sprite-preview">
                        <div class="theme-sprite-image" style="background-image: url('/static/game.data/enemies/${category}/${spriteName}');"></div>
                    </div>
                    <div style="font-size: 10px; color: #ccc;">${spriteName}</div>
                </div>
            `;
        }

        function removeSpriteFromTheme(themeName, spriteName) {
            if (!confirm(`Remover ${spriteName} do tema "${themeName}"?`)) return;
            
            fetch('/admin/api/remove-sprite-from-theme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    theme: themeName,
                    sprite: spriteName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    
                    // Atualizar configura√ß√£o local
                    const category = spriteName.startsWith('body') ? 'body_options' :
                                spriteName.startsWith('head') ? 'head_options' :
                                spriteName.startsWith('weapon') ? 'weapon_options' : 'back_options';
                    
                    const spriteNumber = parseInt(spriteName.replace(/[^0-9]/g, ''));
                    const index = config.themes[themeName][category].indexOf(spriteNumber);
                    if (index > -1) {
                        config.themes[themeName][category].splice(index, 1);
                    }
                    
                    // Recarregar o preview do tema
                    const themeContainer = document.getElementById(`theme-sprites-${themeName.replace(/\s+/g, '-')}`);
                    if (themeContainer) {
                        themeContainer.innerHTML = generateThemeSpritesGrid(themeName);
                    }
                    
                    // Atualizar indicadores de progresso se estiver na tela principal
                    if (typeof updateProgressIndicators === 'function') {
                        updateProgressIndicators();
                    }
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Erro ao remover sprite: ' + error.message, 'error');
            });
        }

        // Download JSON com timestamp autom√°tico
        function downloadJSON() {
            fetch('/admin/api/backup-config')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.config, null, 2)], {
                        type: 'application/json'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.suggested_filename; // Nome com timestamp
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    const info = data.config.backup_info;
                    showMessage(`üíæ Backup salvo: ${info.theme_count} temas, ${info.modifier_count} modificadores!`, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            });
        }

        // Importar configura√ß√£o de arquivo JSON
        function importConfig(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedConfig = JSON.parse(e.target.result);
                    
                    // Validar estrutura do JSON
                    if (!importedConfig.themes || !importedConfig.sprite_modifiers) {
                        showMessage('Arquivo JSON inv√°lido! Faltam campos obrigat√≥rios.', 'error');
                        return;
                    }

                    // Confirmar importa√ß√£o
                    const themeCount = Object.keys(importedConfig.themes).length;
                    const modifierCount = Object.keys(importedConfig.sprite_modifiers).length;
                    
                    if (confirm(`Importar configura√ß√£o?\n\n‚Ä¢ ${themeCount} temas\n‚Ä¢ ${modifierCount} modificadores de sprites\n\n‚ö†Ô∏è Isso SUBSTITUIR√Å a configura√ß√£o atual!`)) {
                        
                        showMessage('üîÑ Importando configura√ß√£o... Por favor aguarde.', 'success');
                        
                        // IMPORTANTE: Importar via API para salvar no servidor
                        fetch('/admin/api/import-config', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ config: importedConfig })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Atualizar configura√ß√£o local apenas se servidor salvou
                                config = importedConfig;
                                updateInterfaceWithConfig();
                                showMessage(`‚úÖ ${data.message}`, 'success');
                            } else {
                                showMessage(`‚ùå Erro no servidor: ${data.message}`, 'error');
                            }
                        })
                        .catch(error => {
                            showMessage(`‚ùå Erro na importa√ß√£o: ${error.message}`, 'error');
                        });
                    }
                } catch (error) {
                    showMessage(`‚ùå Erro ao ler arquivo: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
            
            // Limpar input para permitir reupload do mesmo arquivo
            fileInput.value = '';
        }

        // Juntar m√∫ltiplas configura√ß√µes
        function mergeConfigs() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.multiple = true;
            
            fileInput.onchange = function(e) {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                
                if (confirm(`Juntar ${files.length} arquivos JSON com a configura√ß√£o atual?\n\n‚ö†Ô∏è Temas com mesmo nome ser√£o sobrescritos pelos mais recentes.`)) {
                    processMultipleFiles(files);
                }
            };
            
            fileInput.click();
        }

        // Processar m√∫ltiplos arquivos para merge
        function processMultipleFiles(files) {
            let processedCount = 0;
            let mergedConfig = JSON.parse(JSON.stringify(config)); // Deep copy da config atual
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const fileConfig = JSON.parse(e.target.result);
                        
                        // Merge temas
                        if (fileConfig.themes) {
                            Object.assign(mergedConfig.themes, fileConfig.themes);
                        }
                        
                        // Merge modificadores
                        if (fileConfig.sprite_modifiers) {
                            Object.assign(mergedConfig.sprite_modifiers, fileConfig.sprite_modifiers);
                        }
                        
                        processedCount++;
                        
                        // Quando todos os arquivos foram processados
                        if (processedCount === files.length) {
                            config = mergedConfig;
                            updateInterfaceWithConfig();
                            saveConfigToServer(config);
                            
                            const themeCount = Object.keys(config.themes).length;
                            const modifierCount = Object.keys(config.sprite_modifiers).length;
                            showMessage(`üîó ${files.length} arquivos unidos! Total: ${themeCount} temas e ${modifierCount} modificadores.`, 'success');
                        }
                    } catch (error) {
                        showMessage(`‚ùå Erro ao processar ${file.name}: ${error.message}`, 'error');
                        processedCount++; // Continuar mesmo com erro
                    }
                };
                reader.readAsText(file);
            });
        }

        // Limpar toda a configura√ß√£o
        function clearAll() {
            if (confirm('üóëÔ∏è ATEN√á√ÉO: Isso vai apagar TUDO!\n\n‚Ä¢ Todos os temas criados\n‚Ä¢ Todos os modificadores\n‚Ä¢ Todo o progresso atual\n\nTem certeza?')) {
                config = {
                    themes: {},
                    sprite_modifiers: {},
                    version: '1.0'
                };
                
                updateInterfaceWithConfig();
                saveConfigToServer(config);
                showMessage('üßπ Configura√ß√£o limpa! Come√ßando do zero.', 'success');
            }
        }

        // Atualizar interface com nova configura√ß√£o
        function updateInterfaceWithConfig() {
            // Atualizar dropdown de temas
            const themeSelect = document.getElementById('theme-select');
            themeSelect.innerHTML = '<option value="">Selecione um tema...</option>';
            
            for (const themeName of Object.keys(config.themes)) {
                const option = document.createElement('option');
                option.value = themeName;
                option.textContent = themeName;
                themeSelect.appendChild(option);
            }
            
            // Atualizar lista de temas
            loadThemeList();
            
            // Limpar sele√ß√£o de sprite atual
            currentSprite = null;
            document.getElementById('selected-sprite-info').innerHTML = '<p>Selecione uma sprite para editar seus modificadores</p>';
            document.getElementById('modifier-fields').style.display = 'none';
            
            // Atualizar indicadores de progresso
            updateProgressIndicators();
        }
        
        let animationsEnabled = true;
        
        function toggleAnimations() {
            const btn = document.getElementById('toggle-animation');
            const body = document.body;
            
            animationsEnabled = !animationsEnabled;
            
            if (animationsEnabled) {
                btn.textContent = 'üé¨ Pausar Anima√ß√µes';
                btn.classList.remove('active');
                body.classList.remove('animations-paused');
                body.classList.add('animations-running');
            } else {
                btn.textContent = '‚ñ∂Ô∏è Ativar Anima√ß√µes';
                btn.classList.add('active');
                body.classList.remove('animations-running');
                body.classList.add('animations-paused');
            }
        }

        // Mostrar mensagem
        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);

            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                messagesDiv.removeChild(messageDiv);
            }, 5000);
        }
    </script>
</body>
</html>